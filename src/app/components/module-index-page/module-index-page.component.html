<!-- 
  This document represents the Module Index Page. Simply put, this page lists all 
  the existing modules and arranges them in order based on name, if the name begins
  with a number, the page displays it first from least to most, then alphabetically.
-->

<!-- 
  For representation, the data is disaplyed in a card container, where the Revature
  logo is displayed at the top by default, even in the case of no modules.  
-->
<div class="card" style="margin-bottom: 10px">
    <div class="container">
        <div class="col">
            <div id="content">
                <!-- The source file for the Revature logo -->
                <img src="/assets/img/logo.png" alt="revature" class="logo">
            </div>
        </div>
        <!-- As modules load, a spinner of diamter 30 is displayed -->
        <div *ngIf="ms.isLoading" class="btn spinner">
            <mat-spinner [diameter]="30"></mat-spinner>
        </div>

        <!-- 
                Here lies the directives for dispaying existing modules. For starters, an *ngIf 
                is used with the intent that when the modules is finished loading, it will 
                display a bubble representing a module. 
            -->
        <form *ngIf="!ms.isLoading" style="margin-bottom: 20px">

            <ng-container *ngTemplateOutlet="recursiveList; context:{ $implicit: ms.nodes }">
            </ng-container>

            <ng-template #recursiveList let-list>

                <div *ngFor="let module of list" name="modules" id="{{module.id}}" class="tag-bubble p-0 m-0" [ngClass]="{'parent': module.parents.length === 0}">

                    <ng-container *ngTemplateOutlet="firstGen; context:{ $implicit: module }">
                    </ng-container>

                    <ng-template #firstGen let-module>

                        <!-- 
                            With the creation of bubbles, these are clickable, so simply assigning an 
                            event binding using click will help in revealing content using the listContent()
                            function on the .ts end. In this div, a flag is included to indicate that the 
                            module is empty and has a title of No Content. Also included is the module's name
                            as well as a delete button. 
                        -->

                        <div name="module" style="padding-left: 10px" (click)="listContent(module, $event)">

                            <table>
                                <tbody>
                                    <td style="width:44px">
                                        <a class="lead p-0 m-0">
                                            <font size="+2">
                                                <em class="fa fa-exclamation-triangle" *ngIf="module.links.length === 0" title="No Content">
                                                </em>
                                            </font>
                                        </a>
                                    </td>

                                    <td style="width:44px">
                                        <a class="lead p-0 m-0" (click)="listContent(module); $event.stopPropagation()">
                                            <em class="fa fa-expand" title="View Module Content"></em>
                                        </a>
                                    </td>

                                    <td style="width:44px">
                                        <a class="lead p-0 m-0" (click)="module.children.length == 0 ? '' : listChildren(module); $event.stopPropagation()" [ngClass]="{'text-muted': module.children.length == 0}">
                                            <em class="fa fa-sitemap" [title]="module.children.length == 0 ? 'No Children for Module' : 'View Module Children and Children Content'"></em>
                                        </a>
                                    </td>

                                    <td style="width: 44px">

                                        <a data-toggle="modal" data-target="#deleteModule" title="Delete Module"
                                            (click)="selectedModuleForRemoval(module)">
                                            <font size="+2">
                                                <em class="fas fa-trash" id="delete-module-{{module.id}}">
                                                </em>
                                            </font>  
                                        </a>

                                    </td>

                                    <td (click)="listContent(module)">
                                         <a class="lead p-0 m-0" (click)="listContent(module)">
                                            <font size="+2">{{module.subject}}</font>
                                        </a>
                                    </td>
                                </tbody>
                            </table>
                        </div>

                        <div *ngIf="contentVisible.get(module) || module.parents.length !== 0">

                            <div class="row">

                                <div class="col-5">
                                    <div class="content-container">

                                        <ul class="list-group">

                                            <li class="list-group-item lead text-dark" *ngFor="let link of module.links | contentOrder: module : 1; let i = index"
                                                [attr.id]="'row' + link.content.id" (click)="setActiveContent(module, i)" [ngClass]="{'active': contentActive.get(module) === i}"
                                                draggable="true" (dragstart)="onDragStart($event, i)" (dragover)="onDragOver($event)"
                                                (drop)="onDrop($event, i, module)">

                                                <em style="width:20px;" class="fa" [ngClass]="{'fa-file-code-o': link.content.format === 'Code', 'fa-file-text-o': link.content.format === 'Document', 'fa-file-powerpoint-o': link.content.format === 'Powerpoint'}"></em>

                                                &nbsp; - {{link.priority + 1}} - {{link.content.title}}

                                                <a class="float-right">
                                                    <em title="Remove from module "
                                                        (click)="selectedLinkForRemoval(link, module)"
                                                        class="fas fa-trash" data-toggle="modal"
                                                        data-target="#deleteContent"
                                                        title="Remove Content from Module">
                                                    </em>
                                                </a>

                                            </li>

                                        </ul>

                                        <div class="list-footer btn-group">

                                                <button class="btn btn-block order-btn m-0 fa fa-caret-down" (click)="shiftLinkPriority(module, 1)">
                                                </button>

                                                <button class="btn btn-block order-btn m-0 fa fa-caret-up" (click)="shiftLinkPriority(module, -1)">
                                                </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-6 content-container">

                                    <div class="info-header">

                                        <p *ngIf="contentActive.get(module) != null && contentActive.get(module) != -1" class="p-0 m-0">ID: {{module.links[contentActive.get(module)].content.id}}</p>
                                        <p *ngIf="contentActive.get(module) != null && contentActive.get(module) != -1" class="p-0 m-0">Format: {{module.links[contentActive.get(module)].content.format}}</p>
                                        <p *ngIf="contentActive.get(module) != null && contentActive.get(module) != -1">URL: <a style="margin-top: 10px" target="_blank" href="{{module.links[contentActive.get(module)].content.url}}">{{module.links[contentActive.get(module)].content.url}}</a></p>

                                        <hr *ngIf="contentActive.get(module) != null && contentActive.get(module) != -1" />

                                        <p *ngIf="contentActive.get(module) == null || contentActive.get(module) == -1" class="display-4">No Content</p>

                                    </div>

                                    <div class="info-description">
                                        <form *ngIf="contentActive.get(module) != null && contentActive.get(module) != -1">
                                            <div class="form-group">
                                                <label for="info-description-body">Description</label>
                                                <textarea class="form-control disabled" id="info-description-body" rows="7" disabled>{{module.links[contentActive.get(module)].content.description}}</textarea>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="childrenVisible.get(module)">

                            <ul class="nav nav-tabs">

                                <li *ngFor="let child of module.children; let i = index" class="nav-item" (click)="setActiveChild(module, i);">

                                    <a class="nav-link lead text-dark" [ngClass]="{'active': childActive.get(module) === i}">
                                        <font size="-0.4">
                                            <span class="fas fa-flag" *ngIf="ms.subjectIdToModule.get(child.id).links.length === 0" title="No Content"></span>
                                            &nbsp;{{child.subject}}
                                        </font>
                                    </a>

                                </li>

                            </ul>

                            <div *ngIf="childActive.get(module) != null" class="m-0 p-0">

                                <ng-container *ngTemplateOutlet="childNodes; context:{ $implicit: getChildModule(module) }">
                                </ng-container>

                                <ng-container *ngTemplateOutlet="childNodesInformation">
                                </ng-container>

                            </div>
                        </div>
                    </ng-template>

                    <ng-template #childNodes let-module>

                        <div *ngIf="module.children.length > 0">

                            <ul class="nav nav-tabs">

                                <li *ngFor="let child of module.children; let i = index" class="nav-item" (click)="setActiveChild(module, i);">

                                    <a class="nav-link lead text-dark" [ngClass]="{'active': childActive.get(module) === i}">
                                        <font size="-0.4">
                                            <span class="fas fa-flag" *ngIf="ms.subjectIdToModule.get(child.id).links.length === 0" title="No Content"></span>
                                            &nbsp;{{child.subject}}
                                        </font>
                                    </a>

                                </li>

                            </ul>

                            <div *ngIf="module.children.length > 0 && childActive.get(module) != null && childActive.get(module) != -1" class="m-0 p-0">

                                <ng-container *ngTemplateOutlet="childNodes; context:{ $implicit: getChildModule(module) }">
                                </ng-container>

                            </div>

                        </div>
                    </ng-template>

                    <ng-template #childNodesInformation>

                        <div>
                            <div class="row">
                                <div class="col-5">
                                    <div class="child-header mb-1 mt-2">
                                        <p class="lead p-0 ml-1 mb-0 float-left">{{activeModule.subject}}</p>

                                        <a data-toggle="modal" data-target="#deleteModule" title="Delete Module"
                                            (click)="selectedModuleForRemoval(activeModule)" class="lead float-right">
                                            <em class="fas fa-trash" id="delete-module-{{module.id}}">
                                            </em>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="row" >
                                <div class="col-5">
                                    <div class="content-container mt-0">
                                        <ul class="list-group list-group-flush">

                                            <li class="list-group-item lead text-dark" *ngFor="let link of activeModule.links | contentOrder: activeModule : 1; let i = index"
                                                [attr.id]="'row' + link.content.id" (click)="setActiveContent(activeModule, i)" [ngClass]="{'active': contentActive.get(activeModule) === i}"
                                                draggable="true" (dragstart)="onDragStart($event, i)" (dragover)="onDragOver($event)"
                                                (drop)="onDrop($event, i, activeModule)">

                                                <em style="width:20px;" class="fa" [ngClass]="{'fa-file-code-o': link.content.format === 'Code', 'fa-file-text-o': link.content.format === 'Document', 'fa-file-powerpoint-o': link.content.format === 'Powerpoint'}"></em>

                                                &nbsp; - {{link.priority + 1}} - {{link.content.title}}

                                                <a class="float-right">
                                                    <em title="Remove from module "
                                                        (click)="selectedLinkForRemoval(link, activeModule)"
                                                        class="fas fa-trash" data-toggle="modal"
                                                        data-target="#deleteContent"
                                                        title="Remove Content from Module">
                                                    </em>
                                                </a>
                                            </li>

                                        </ul>
                                        <div class="list-footer btn-group">

                                            <button class="btn btn-block order-btn m-0 fa fa-caret-down" (click)="shiftLinkPriority(activeModule, 1)">
                                            </button>

                                            <button class="btn btn-block order-btn m-0 fa fa-caret-up" (click)="shiftLinkPriority(activeModule, -1)">
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-6 content-container">

                                    <div class="info-header">

                                        <p *ngIf="contentActive.get(activeModule) != null && contentActive.get(activeModule) != -1" class="p-0 m-0">ID: {{activeModule.links[contentActive.get(activeModule)].content.id}}</p>
                                        <p *ngIf="contentActive.get(activeModule) != null && contentActive.get(activeModule) != -1" class="p-0 m-0">Format: {{activeModule.links[contentActive.get(activeModule)].content.format}}</p>
                                        <p *ngIf="contentActive.get(activeModule) != null && contentActive.get(activeModule) != -1">URL: <a style="margin-top: 10px" target="_blank" href="{{activeModule.links[contentActive.get(activeModule)].content.url}}">{{activeModule.links[contentActive.get(activeModule)].content.url}}</a></p>

                                        <hr *ngIf="contentActive.get(activeModule) != null && contentActive.get(activeModule) != -1" />

                                        <p *ngIf="contentActive.get(activeModule) == null || contentActive.get(activeModule) == -1" class="display-4">No Content</p>

                                    </div>

                                    <div class="info-description">
                                        <form *ngIf="contentActive.get(activeModule) != null && contentActive.get(activeModule) != -1">
                                            <div class="form-group">
                                                <label for="info-description-body">Description</label>
                                                <textarea class="form-control disabled" id="info-description-body" rows="7" disabled>{{activeModule.links[contentActive.get(activeModule)].content.description}}</textarea>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </ng-template>
                    
                </div>
            </ng-template>
        </form>

    </div>

    <!-- 
      Here is a pop up the occurs when deleting content. Simply put, this creates a pop
      up box, titled "Removing Content", and asks for confirmation of removal. To do this, 
      String Interpolation is used to say what subject is being deleted from what title, 
      and a button is used to confirm. 
     -->
    <div id="deleteContent" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Removing Content</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div *ngIf="selLink && selModule" class="modal-body">
                    <h6>Are you sure you want to remove {{selLink.content.title}} from {{selModule.subject}}?</h6>
                    <h6><small>This content will not be deleted, only removed for {{selModule.subject}}.</small></h6>
                    <div class="row btn mb-3">

                        <!-- 
                Here is the confirm button which utilizes the removeContentFromModuleIndex() 
                function.
               -->
                        <button type="button" class="btn btn-primary" id="deleteContentButton"
                            (click)="removeContentFromModuleIndex()" data-dismiss="modal">Confirm Removal</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 
      Here is a pop up the occurs when deleting a module. Simply put, this creates a pop
      up box, titled "Removing Module", and asks for confirmation of removal. To do this, 
      String Interpolation is used to say what module is being deleted, 
      and a button is used to confirm.
     -->
    <div id="deleteModule" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Deleting Module</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div *ngIf="selModule" class="modal-body">
                    <h6>Are you sure you want to delete the {{selModule.subject}} module?</h6>
                    <div class="row btn mb-3">
                        <form>
                            <h5><small>Delete module and
                                    <select id="Seldelmethod">
                                        <option value="1">Keep all content</option>
                                        <option value="2">Associated content to this module</option>
                                        <option value="3">All content related to this module</option>
                                    </select>
                                </small></h5>
                            <button type="button" class="btn btn-primary" id="deleteModuleButton"
                                (click)="removeModule()" data-dismiss="modal">Confirm Removal</button>
                        </form>
                        <!-- 
                Here is the confirm button which utilizes the removeContentFromModuleIndex() 
                function.
               -->
                    </div>
                </div>
            </div>

        </div>
    </div>